<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Search Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #customer-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        #customer-dropdown .dropdown-item {
            cursor: pointer;
            padding: 0.75rem 1rem;
        }
        
        #customer-dropdown .dropdown-item:hover {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <h3>Customer Search Test</h3>
                <div class="mb-3">
                    <label for="customer-search" class="form-label">Customer</label>
                    <div class="position-relative">
                        <input type="text" id="customer-search" class="form-control" 
                               placeholder="Search by name or mobile number..." 
                               autocomplete="off">
                        <input type="hidden" id="customer-id" value="">
                        <div id="customer-dropdown" class="dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                            <!-- Customer search results will appear here -->
                        </div>
                        <small class="form-text text-muted">
                            Selected: <span id="selected-customer">Walk-in Customer</span>
                        </small>
                    </div>
                </div>
                <div class="alert alert-info">
                    <strong>Instructions:</strong><br>
                    1. Type "Ha" to find customers with names containing "Ha"<br>
                    2. Type "171" to find customers with phone numbers containing "171"<br>
                    3. Type "mi" to find customers with names containing "mi"
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(function() {
            console.log('Test page loaded');
            initializeCustomerSearch();
        });

        function initializeCustomerSearch() {
            console.log('Initializing customer search...');
            
            const customerSearch = $('#customer-search');
            const customerDropdown = $('#customer-dropdown');
            const customerIdInput = $('#customer-id');
            const selectedCustomerSpan = $('#selected-customer');
            
            console.log('Customer search elements:', {
                searchInput: customerSearch.length,
                dropdown: customerDropdown.length,
                hiddenInput: customerIdInput.length,
                selectedSpan: selectedCustomerSpan.length
            });
            
            // Search customers with debounce
            customerSearch.on('input', debounce(function() {
                const query = $(this).val().trim();
                console.log('Customer search input:', query);
                
                if (query.length < 2) {
                    customerDropdown.hide().empty();
                    return;
                }
                
                console.log('Making AJAX request for customer search...');
                // Make AJAX request to search customers
                $.ajax({
                    url: '/sales/api/search-customers/',
                    type: 'GET',
                    data: { q: query },
                    success: function(response) {
                        console.log('Customer search success:', response);
                        displayCustomerResults(response.customers);
                    },
                    error: function(xhr, status, error) {
                        console.error('Customer search failed:', error, xhr.responseText);
                        
                        // Show error message
                        customerDropdown.html('<div class="dropdown-item-text text-danger">Search failed - check console for details</div>');
                        customerDropdown.show();
                    }
                });
            }, 300));
            
            // Handle clicking outside to hide dropdown
            $(document).on('click', function(e) {
                if (!$(e.target).closest('#customer-search, #customer-dropdown').length) {
                    customerDropdown.hide();
                }
            });
        }

        function displayCustomerResults(customers) {
            const customerDropdown = $('#customer-dropdown');
            
            if (customers.length === 0) {
                customerDropdown.html('<div class="dropdown-item-text text-muted">No customers found</div>');
                customerDropdown.show();
                return;
            }
            
            let html = '';
            customers.forEach(function(customer) {
                html += `
                    <a class="dropdown-item customer-result" 
                       href="#" 
                       data-customer-id="${customer.id}"
                       data-customer-name="${customer.name}"
                       data-customer-phone="${customer.phone_number}">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">${customer.name}</span>
                            <small class="text-muted">${customer.phone_number}</small>
                        </div>
                    </a>
                `;
            });
            
            customerDropdown.html(html).show();
            
            // Handle customer selection
            $('.customer-result').on('click', function(e) {
                e.preventDefault();
                
                const customerId = $(this).data('customer-id');
                const customerName = $(this).data('customer-name');
                const customerPhone = $(this).data('customer-phone');
                
                // Update form values
                $('#customer-id').val(customerId);
                $('#customer-search').val(`${customerName} - ${customerPhone}`);
                $('#selected-customer').text(`${customerName} (${customerPhone})`);
                
                // Hide dropdown
                customerDropdown.hide();
                
                console.log('Customer selected:', customerName, customerId);
            });
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>